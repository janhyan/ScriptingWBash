#!/bin/bash

MACS="MACs hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,umac-128@openssh.com,hmac-sha2-512"

echo "Detecting vulnerable SHA1 algorithms..."

# Check for vulnerable SHA1 algorithms in sshd_config
if sudo sshd -T | grep -q hmac-sha1; then
    echo "FOUND VULNERABLE SHA1 ALGORITHM"
    echo "REMOVING VULNERABILITY"

    # Create a backup of sshd_config
    echo "Creating sshd_config backup"
    sudo cp -a /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

    # Insert the new MACs line if it's not already present in the file
    sudo sed -i '1{/'"$MACS"'/!i\
'"$MACS"'
}' /etc/ssh/sshd_config

    # Restart SSH service
    echo "Restarting sshd service..."
    sudo systemctl restart sshd

else
    echo "No SHA1 vulnerabilities found."
fi
